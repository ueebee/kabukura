# Kabukura アーキテクチャ設計書

## 1. システム概要

Kabukuraは、J-Quants APIを利用して株式市場データを取得・分析するためのElixir/Phoenixベースのアプリケーションです。

## 2. システムアーキテクチャ

### 2.1 全体構成

```
lib/
├── kabukura/                 # コアロジック
│   ├── auth/                # 認証関連
│   │   ├── strategy.ex     # 認証ストラテジーインターフェース
│   │   ├── strategy_registry.ex # 認証ストラテジー管理
│   │   └── jquants_strategy.ex # J-Quants認証実装
│   ├── data_sources/        # データソース管理
│   │   └── jquants/        # J-Quants API実装
│   │       ├── auth.ex     # 認証処理
│   │       ├── http.ex     # HTTPリクエスト処理
│   │       ├── token_store.ex # トークン管理
│   │       ├── listed_info.ex # 上場企業情報取得
│   │       ├── daily_quotes.ex # 日次株価データ取得
│   │       ├── sector33_code.ex # 33業種コード管理
│   │       ├── sector17_code.ex # 17業種コード管理
│   │       └── market_code.ex # 市場区分コード管理
│   ├── encryption.ex       # 認証情報の暗号化
│   ├── company.ex         # 企業情報スキーマ
│   ├── stock_price.ex     # 株価データスキーマ
│   └── data_source.ex     # データソーススキーマ
├── kabukura_web/           # Webインターフェース
│   ├── controllers/        # APIエンドポイント
│   │   ├── company_controller.ex # 企業情報API
│   │   └── stock_price_controller.ex # 株価データAPI
│   └── views/             # レスポンス形式
│       ├── company_view.ex # 企業情報レスポンス
│       └── stock_price_view.ex # 株価データレスポンス
└── kabukura/              # アプリケーション設定
    ├── application.ex     # アプリケーション設定
    └── repo.ex           # データベース設定
```

### 2.2 主要コンポーネント

#### 2.2.1 認証管理 (`lib/kabukura/auth/`)
- 認証ストラテジーのインターフェース定義
- プロバイダー別の認証実装
- 認証ストラテジーの管理

##### 2.2.1.1 認証ストラテジー (`strategy.ex`)
- 認証ストラテジーのインターフェース定義
- トークン取得・管理の標準化
- 有効期限管理の標準化

##### 2.2.1.2 認証ストラテジーレジストリ (`strategy_registry.ex`)
- プロバイダー別の認証ストラテジー管理
- 動的な認証ストラテジーの選択
- 新しい認証方式の追加を容易に

##### 2.2.1.3 J-Quants認証実装 (`jquants_strategy.ex`)
- J-Quants API固有の認証フロー実装
- トークンの取得と更新
- エラーハンドリング

#### 2.2.2 データソース管理 (`lib/kabukura/data_sources/`)
- J-Quants APIとの通信を担当
- 認証情報の管理
- データの取得とキャッシュ

##### 2.2.2.1 J-Quants認証 (`jquants/auth.ex`)
- トークンの取得、更新、管理
- 認証情報の暗号化/復号化との連携
- トークンの有効期限管理

##### 2.2.2.2 J-Quants HTTP処理 (`jquants/http.ex`)
- HTTPリクエストの処理
- エラーハンドリングとリトライ
- レート制限の考慮
- タイムアウト設定

##### 2.2.2.3 J-Quantsトークン管理 (`jquants/token_store.ex`)
- トークンの永続化
- トークンの自動更新
- トークンの有効期限管理

##### 2.2.2.4 J-Quants上場企業情報 (`jquants/listed_info.ex`)
- 上場企業情報の取得
- データベースへの保存
- 企業情報の更新管理

##### 2.2.2.5 J-Quants株価データ (`jquants/daily_quotes.ex`)
- 日次株価データの取得
- 期間指定による株価データの取得
- データベースへの保存と更新
- トランザクション管理

##### 2.2.2.6 J-Quantsコード管理
- 33業種コード管理 (`jquants/sector33_code.ex`)
  - 業種コードと名称の変換
  - コード一覧の管理
- 17業種コード管理 (`jquants/sector17_code.ex`)
  - 業種コードと名称の変換
  - コード一覧の管理
- 市場区分コード管理 (`jquants/market_code.ex`)
  - 市場コードと名称の変換
  - コード一覧の管理

#### 2.2.3 データモデル

##### 2.2.3.1 企業情報 (`company.ex`)
- 企業情報のスキーマ定義
- J-Quants APIデータの変換
- バリデーション

##### 2.2.3.2 データソース (`data_source.ex`)
- データソースのスキーマ定義
- 認証情報の暗号化/復号化
- レート制限の管理

## 3. データフロー

1. J-Quants APIからデータを取得
   - 認証情報の暗号化/復号化
   - トークンの取得と更新
   - HTTPリクエストの送信
   - 各種コードの変換（業種、市場区分）

2. データを変換・正規化
   - APIレスポンスの変換
   - スキーマへのマッピング
   - バリデーション
   - コード値の変換

3. データベースへの保存
   - 企業情報の保存
   - 株価データの保存
   - 重複チェック
   - 更新日時の管理
   - トランザクション管理

4. Web APIを通じて結果を提供
   - データの取得
   - レスポンスの整形
   - エラーハンドリング

## 4. セキュリティ設計

- 認証情報の暗号化（`lib/kabukura/encryption.ex`）
- 環境変数による設定管理
- APIキーの安全な管理
- レート制限の実装
- トークンの安全な管理

## 5. スケーラビリティ

- モジュール化された設計による機能の追加のしやすさ
- 新しいデータソースの追加が容易
- 認証ストラテジーの拡張性
- データモデルの拡張性

## 6. 監視とロギング

- データ取得の成功/失敗のログ
- システムの健全性モニタリング
- エラー通知の実装
- トークン管理の状態監視

## 7. J-Quants API実装方針

### 7.1 認証フロー

1. **初期認証**
   - ユーザー名/パスワードでリフレッシュトークンを取得
   - リフレッシュトークンは暗号化して保存
   - トークンの有効期限を管理

2. **トークン更新**
   - リフレッシュトークンでアクセストークン（IDトークン）を取得
   - アクセストークンは有効期限を考慮して管理
   - トークンの自動更新

3. **トークン管理**
   - トークンの有効期限をチェック
   - 必要に応じて自動更新
   - トークンのキャッシュ
   - トークンの永続化

### 7.2 HTTP処理設計

1. **リクエスト/レスポンス処理**
   - 標準化されたリクエスト/レスポンス処理
   - エラーハンドリングの統一
   - リトライロジックの実装
   - パラメータのエンコード

2. **レート制限対応**
   - リクエスト間隔の制御
   - バックオフ戦略の実装
   - レート制限超過時の処理

3. **エラーハンドリング**
   - 標準化されたエラー型
   - エラーメッセージの統一
   - エラーログの記録
   - リトライ戦略の実装

4. **データ変換**
   - 業種コードの変換（17業種、33業種）
   - 市場区分コードの変換
   - 日付形式の変換
   - 数値データの正規化 